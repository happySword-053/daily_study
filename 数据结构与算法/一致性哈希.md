一致性哈希（Consistent Hashing）是一种分布式算法，主要用于在动态变化的分布式环境中（如服务器集群、缓存系统、数据库分片等）**高效分配数据或请求** ，同时**最小化节点增减时的数据迁移量** 

### **核心思想**

- **传统哈希的痛点** ：  
    假设使用简单哈希（如 `hash(key) % N`，N为节点数），当节点数N变化时，几乎所有数据都需要重新分布，导致大规模迁移。
    
- **一致性哈希的改进** ：  
    将数据和节点映射到一个**虚拟的哈希环** 上，通过顺时针寻找最近的节点，使得节点增减时仅影响邻近的数据，而非全局。




一致性哈希的核心思想是：**把数据和服务器都映射到一个环上** ，让服务器增减时，只影响邻近的数据，而不是全局。

#### **（1）构建哈希环**

- **环的范围** ：假设哈希值是0~2^32-1（一个大圆环）。
- **服务器映射** ：用哈希函数计算每台服务器的IP或名称，得到一个哈希值，放在环上。
- **数据映射** ：用同样的哈希函数计算数据的键（如用户ID），得到哈希值，放在环上。

**示例** ：

- 服务器A的哈希值是100，服务器B是300，服务器C是500。
- 数据键是"用户123"，哈希值是200。

#### **（2）数据分配规则**

数据顺时针找到最近的服务器：

- "用户123"的哈希值是200 → 顺时针最近的服务器是B（300）。


         服务器A(100)

         ↗ ↖

数据200                →                                       服务器C(500)

              ↘ ↗

           服务器B(300) 



**初始状态** （3台服务器）：

- 服务器A（哈希值100）
- 服务器B（哈希值300）
- 服务器C（哈希值500）

**哈希环范围** ：0 ~ 600（假设为简化计算）。

**数据分布规则** ：

- 一个数据的哈希值落在某个服务器的**顺时针区间** ，则由该服务器负责。

**初始数据分布** ：

- 数据哈希值 **0~100** → 服务器A（100）
- 数据哈希值 **100~300** → 服务器B（300）
- 数据哈希值 **300~500** → 服务器C（500）
- 数据哈希值 **500~600** → 服务器A（100）（环是循环的）

---

### **新增服务器D（哈希值400）**

**新服务器D的位置** ：插入到B（300）和C（500）之间。

**新的数据分布** ：

- 数据哈希值 **0~100** → 服务器A（100）
- 数据哈希值 **100~300** → 服务器B（300）
- 数据哈希值 **300~400** → 服务器D（400）（新增区间）
- 数据哈希值 **400~500** → 服务器C（500）
- 数据哈希值 **500~600** → 服务器A（100）

**受影响的数据** ：

- **原属于服务器C的数据** ：哈希值 **300~500** 。
- **新增服务器D后** ：
    - 哈希值 **300~400** 的数据现在由D负责 → **需要从C迁移到D** 。
    - 哈希值 **400~500** 的数据仍由C负责 → **无需迁移** 。

---

### **为什么是迁移300~400的数据？**

- **服务器D的覆盖范围** ：从B（300）到D（400）之间的数据。
- **服务器C的覆盖范围** ：从D（400）到C（500）之间的数据。
- **迁移的只有D覆盖的区间** ：即原属于C的300~400部分。