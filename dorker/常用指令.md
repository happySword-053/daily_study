### **Dockerfile 核心指令详解**

#### 1. **基础指令**

|指令|作用|示例|
|---|---|---|
|`FROM`|指定基础镜像|`FROM ubuntu:20.04`|
|`LABEL`|添加元数据（作者、版本等）|`LABEL maintainer="your@email.com"`|
|`WORKDIR`|设置工作目录（后续命令的路径）|`WORKDIR /app`|

#### 2. **构建过程指令**

|指令|作用|示例|
|---|---|---|
|`COPY`|复制**宿主机文件**到镜像|`COPY ./src /app/src`|
|`ADD`|类似 `COPY`，但支持**URL和解压压缩包**|`ADD https://example.com/file.tar.gz /app`  <br>`ADD file.tar.gz /app`|
|`RUN`|**执行命令**（安装依赖、编译等）|`RUN apt-get update && apt-get install -y python3`|
|`ENV`|设置环境变量|`ENV NODE_ENV=production`|

#### 3. **运行配置指令**

|指令|作用|示例|
|---|---|---|
|`EXPOSE`|声明容器运行时监听的端口|`EXPOSE 80`|
|`CMD`|容器启动时执行的**默认命令**|`CMD ["python", "app.py"]`|
|`ENTRYPOINT`|类似 `CMD`，但不可被覆盖|`ENTRYPOINT ["nginx", "-g", "daemon off;"]`|
|`USER`|切换运行用户（提高安全性）|`USER nobody`|
|`VOLUME`|创建数据卷挂载点（持久化数据）|`VOLUME ["/data"]`|

---

### **完整 Dockerfile 示例**

dockerfile

复制

下载

# 1. 基础镜像
FROM python:3.9-slim

# 2. 设置元数据和工作目录
LABEL author="Dev"
WORKDIR /app

# 3. 复制依赖文件并安装
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 4. 复制应用代码
COPY src/ .

# 5. 设置环境变量
ENV PORT=8080

# 6. 声明端口
EXPOSE $PORT

# 7. 容器启动命令
CMD ["gunicorn", "--bind", "0.0.0.0:$PORT", "app:app"]

---

### **关键编写原则**

1. **精简镜像**：
    
    - 使用官方小型基础镜像（如 `alpine`、`-slim` 版本）。
        
    - 合并 `RUN` 命令减少镜像层：
        
        dockerfile
        
        
        RUN apt-get update && apt-get install -y \
            git \
            curl \
            && rm -rf /var/lib/apt/lists/*  # 清理缓存
        
2. **利用缓存加速构建**：
    
    - 变动少的步骤（如安装依赖）放在前面，变动多的步骤（如复制代码）靠后。
        
3. **安全优化**：
    
    - 避免以 `root` 运行：`USER 1000`
        
    - 不存储敏感数据：用 `--build-arg` 或密钥管理工具传递密码。
        

---

### **高级技巧：多阶段构建**

> 用于分离构建环境和运行环境，减小最终镜像体积

dockerfile

复制

下载

# ---------- 阶段1：构建环境 ----------
FROM node:18 AS builder
WORKDIR /build
COPY package.json .
RUN npm install
COPY . .
RUN npm run build  # 生成 dist 目录

# ---------- 阶段2：运行环境 ----------
FROM nginx:alpine
COPY --from=builder /build/dist /usr/share/nginx/html  # 仅复制构建产物
EXPOSE 80

---

### **构建与运行命令**

1. **构建镜像**（末尾的点表示 Dockerfile 所在路径）：
    
    bash
    
    复制
    
    下载
    
    docker build -t my-app:1.0 .
    
2. **运行容器**：
    
    bash
    
    复制
    
    下载
    
    docker run -d -p 8080:8080 --name my-app-container my-app:1.0
    

---

### **调试与排查**

- **查看镜像构建历史**：
    
    bash
    
    复制
    
    下载
    
    docker history my-app:1.0
    
- **临时禁用缓存**（强制重新构建）：
    
    bash
    
    复制
    
    下载
    
    docker build --no-cache -t my-app:1.0 .
    
- **进入构建中的容器调试**（在 `RUN` 指令前加 `exit 1` 中断构建）。