统计某个网站的uv(unique visitor 独立访客，一般理解为客户端IP) 大规模防止作弊，需要去除重复统计，独立访客，比如ip同样就认为是同一用户

hyperloglog的优点是，在输入元素的数量或体积非常大的时候，计算基数所需的空间总是固定的，并且是很小的
在redis里面，每个hyperloglog键只需消耗12KB内存，就可以计算接近2^64个不同的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比
hyperloglog只会根据输入元素来计算基数，不会存储元素本身

基数是一种数据集，去重复后的真实个数，相当于集合的大小
#### Redis 中的使用

  

Redis 是一个广泛使用的键值对存储数据库，它实现了 HyperLogLog 数据结构，以下是一些常见操作：

  

- **添加元素**：使用 `PFADD` 命令向 HyperLogLog 中添加元素。

  

收起

plaintext

```
PFADD key element [element ...]
```

  

例如：

  

收起

plaintext

```
PFADD myhyperloglog element1 element2 element3
```

  

- **估算基数**：使用 `PFCOUNT` 命令估算 HyperLogLog 中不同元素的数量。

  

收起

plaintext

```
PFCOUNT key [key ...]
```

  

例如：

  

收起

plaintext

```
PFCOUNT myhyperloglog
```

  

- **合并 HyperLogLog**：使用 `PFMERGE` 命令将多个 HyperLogLog 合并成一个。

  

收起

plaintext

```
PFMERGE destkey sourcekey [sourcekey ...]
```

  

例如：

  

收起

plaintext

```
PFMERGE mergedhyperloglog myhyperloglog1 myhyperloglog2
```






# 案例
#### 网站 UV 统计

  

在网站分析中，需要统计每天、每周或每月的独立访客数量（UV）。如果使用传统的集合来存储每个访客的标识，当访问量非常大时，会占用大量的内存。而 HyperLogLog 可以用很小的内存空间来估算 UV，误差在可接受范围内。

#### 广告投放分析

  

广告平台需要统计广告的独立曝光数或独立点击数。通过 HyperLogLog，可以高效地估算这些基数，帮助广告商了解广告的效果。

#### 数据去重统计

  

在数据处理过程中，有时需要统计不同数据记录的数量。例如，统计数据库中不同用户 ID 的数量、不同 IP 地址的数量等。使用 HyperLogLog 可以在不存储所有数据的情况下，快速估算出不同元素的数量。#### 网站 UV 统计

  

在网站分析中，需要统计每天、每周或每月的独立访客数量（UV）。如果使用传统的集合来存储每个访客的标识，当访问量非常大时，会占用大量的内存。而 HyperLogLog 可以用很小的内存空间来估算 UV，误差在可接受范围内。

#### 广告投放分析

  

广告平台需要统计广告的独立曝光数或独立点击数。通过 HyperLogLog，可以高效地估算这些基数，帮助广告商了解广告的效果。

#### 数据去重统计

  

在数据处理过程中，有时需要统计不同数据记录的数量。例如，统计数据库中不同用户 ID 的数量、不同 IP 地址的数量等。使用 HyperLogLog 可以在不存储所有数据的情况下，快速估算出不同元素的数量。

### 原理

#### 基本思想

  

HyperLogLog 基于概率统计的思想，利用哈希函数将元素映射到一个二进制位串中，通过记录这些位串中第一个 1 出现的位置，来估算集合的基数。

#### 具体步骤

  

- **哈希处理**：对于集合中的每个元素，使用一个哈希函数将其映射到一个固定长度的二进制位串。哈希函数的作用是将元素均匀地分布到整个哈希空间中，以保证统计的准确性。
- **分桶计数**：将哈希后的二进制位串划分为多个桶（通常为 2^m 个桶，m 是一个可配置的参数），每个桶记录该桶中所有元素哈希值的第一个 1 出现的最大位置。
- **估算基数**：根据每个桶中记录的最大位置，使用特定的公式来估算集合的基数。这个公式会考虑到所有桶的统计信息，并进行一些修正，以减少误差。

#### 误差控制

  

HyperLogLog 的误差率主要取决于桶的数量，桶的数量越多，误差率越低。一般来说，HyperLogLog 的相对误差率约为 1.04 / √(2^m)，其中 m 是桶的数量的对数。例如，当 m = 16 时，桶的数量为 2^16 = 65536，相对误差率约为 0.81%。

  

总之，HyperLogLog 是一种非常实用的算法，在需要估算大规模数据集基数的场景中具有显著的优势。